generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      String   // ADMIN, PLANNER, MARKETER, WORKER, WAREHOUSE, VIEWER
  createdProducts Product[] @relation("CreatedProducts")
  createdOrders   Order[]   @relation("CreatedOrders")
  createdAt DateTime @default(now())
  logs      ProductionLog[]
  auditLogs AuditLog[]
  supportTickets SupportTicket[]

}

// Order Grouping (Sipariş)
model Order {
  id          Int       @id @default(autoincrement())
  externalId  String?   @unique // NetSim ALISSATIS_NO referansı
  name        String    // Sipariş Adı / Ref
  company     String    // Müşteri / Firma
  customerName String?  // Müşteri Unvanı
  description String?   // Sipariş açıklaması
  orderDate   DateTime? // Sipariş tarihi
  deliveryDate DateTime? // Teslim tarihi
  totalAmount Float?    // Toplam tutar
  currency    String?   @default("TL") // Para birimi
  status      String    @default("REQUESTED") // REQUESTED, PLANNED, APPROVED, COMPLETED, CANCELLED
  marketingById Int?
  marketingBy User?     @relation("CreatedOrders", fields: [marketingById], references: [id])
  createdById Int?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Product Line Item (Ürün / İş Emri)
model Product {
  id          Int      @id @default(autoincrement())
  externalId  String?  @unique // NetSim ALISSATIS_DETAY_NO referansı
  orderId     Int?
  order       Order?   @relation(fields: [orderId], references: [id])

  name        String
  model       String
  sku         String?  // Stok kodu

  // Quantities
  quantity    Int      // Planlanan Adet
  produced    Int      @default(0) // Toplam Üretilen
  unit        String?  @default("Adet") // Birim
  unitPrice   Float?   // Birim fiyat
  totalPrice  Float?   // Toplam fiyat
  sortOrder   Int?     @default(0) // Sıra numarası
  
  // Dates
  orderDate   DateTime @default(now())
  terminDate  DateTime? // Planlama tarafından girilecek (Optional initially)
  productionDate DateTime? // Üretim tarihi (Planlanan/Gerçekleşen)
  
  // Specs
  material    String?
  description String?
  marketingDescription String? // Pazarlamacı notu
  rejectionReason String? // Red nedeni
  imageUrl    String?

  // NetSim Açıklamalar
  aciklama1   String?
  aciklama2   String?
  aciklama3   String?
  aciklama4   String?
  dstAdi      String?  // DST - Değişken Stok (Renk vb.)

  // Config
  footType     String?
  footMaterial String?
  armType      String?
  backType     String?
  fabricType   String?
  
  master      String? // Usta Adi

  status      String   @default("PENDING")
  subStatus   String?  // Alt durum (Dosendi, Montajda, Paketleme Bekliyor, Sevk Bekliyor, vb.)

  // Uretim Muhendisi Notlari ve Asamalar
  engineerNote    String?  // Muhendis aciklamasi
  cutQuantity     Int      @default(0) // Kesim yapilan adet
  foamQty         Int      @default(0) // Sünger yapilan adet
  upholsteryQty   Int      @default(0) // Doseme yapilan adet
  assemblyQty     Int      @default(0) // Montaj yapilan adet
  qualityQty      Int      @default(0) // Kalite kontrol gecen adet
  packagedQty     Int      @default(0) // Paketlenen adet
  storedQty       Int      @default(0) // Depoya alinan adet
  shippedQty      Int      @default(0) // Sevk edilen adet

  createdById Int?
  creator     User?    @relation("CreatedProducts", fields: [createdById], references: [id])
  
  systemCode  String   @unique
  barcode     String?  @unique
  
  createdAt   DateTime @default(now())
  
  // Relations
  logs        ProductionLog[]
  inventory   Inventory[]
  bom         BomItem[]
  shipmentItems ShipmentItem[]
  components    ProductComponent[]
}

// Multi-Shelf Inventory (Raf Stok)
model Inventory {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  shelf     String
  quantity  Int
  updatedAt DateTime @updatedAt

  @@unique([productId, shelf])
}

// Production Log
model ProductionLog {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  quantity  Int
  shelf     String?  // Logged for history, even if Inventory is source of truth
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  createdAt DateTime @default(now())
}

// Shipment (Sevkiyat)
model Shipment {
  id            Int      @id @default(autoincrement())
  company       String
  driverName    String?
  vehiclePlate  String?
  exitDate      DateTime? // Actual exit date (optional until shipped)
  estimatedDate DateTime? // Planned exit date
  status        String   @default("PLANNED") // PLANNED, SHIPPED, DELIVERED
  items         ShipmentItem[]
  createdAt     DateTime @default(now())
}

model ShipmentItem {
  id          Int      @id @default(autoincrement())
  shipment    Shipment @relation(fields: [shipmentId], references: [id])
  shipmentId  Int
  product     Product  @relation(fields: [productId], references: [id])
  productId   Int
  quantity    Int
}

// MRP: Raw Materials / Parts
model Part {
  id        Int      @id @default(autoincrement())
  name      String
  stock     Int      @default(0)
  onOrder   Int      @default(0) // Miktar (Sipariş edilen)
  threshold Int      @default(10) // Kritik stok seviyesi
  unit      String   @default("adt")
  createdAt DateTime @default(now())
  bomItems  BomItem[]
}

// Bill of Materials (Reçete)
model BomItem {
  id        Int     @id @default(autoincrement())
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  part      Part    @relation(fields: [partId], references: [id])
  partId    Int
  quantity  Int     // Quantity required per 1 unit of Product
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  action    String
  entity    String
  entityId  String
  details   String?
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model ProductCatalog {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  imageUrl  String?
}

model ProductFeature {
  id        Int      @id @default(autoincrement())
  category  String
  name      String
  createdAt DateTime @default(now())
}

model SupportTicket {
  id        Int      @id @default(autoincrement())
  title     String
  description String
  status    String   @default("OPEN")
  priority  String   @default("NORMAL")
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Yarı Mamül (Semi-Finished Product)
model SemiFinished {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  description String?
  quantity    Int      @default(0)  // Mevcut stok
  minStock    Int      @default(10) // Minimum stok seviyesi
  unit        String   @default("adet")
  category    String?  // Kategori (iskelet, sünger, kumaş vb.)
  location    String?  // Depo lokasyonu
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  logs        SemiFinishedLog[]
}

// Yarı Mamül Stok Hareketi
model SemiFinishedLog {
  id              Int          @id @default(autoincrement())
  semiFinished    SemiFinished @relation(fields: [semiFinishedId], references: [id])
  semiFinishedId  Int
  type            String       // IN (giriş), OUT (çıkış)
  quantity        Int
  note            String?
  createdAt       DateTime     @default(now())
}

// Bildirimler (Admin'e gelen bildirimler)
model Notification {
  id          Int      @id @default(autoincrement())
  type        String   // MARKETING_REJECT, APPROVAL_NEEDED, etc.
  title       String
  message     String
  productId   Int?
  productName String?
  systemCode  String?
  isRead      Boolean  @default(false)
  createdBy   String?  // Bildirimi oluşturan kullanıcı adı
  createdAt   DateTime @default(now())
}

model ProductComponent {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  category  String
  value     String
  createdAt DateTime @default(now())

  @@unique([productId, category])
}
